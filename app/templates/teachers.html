{% extends "base.html" %}

{% block title %}教师管理 · 教务管理平台{% endblock %}

{% block content %}
  <section class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">教师总数</p>
          <p class="display-6 fw-semibold mb-0">{{ teacher_total }}</p>
          <p class="text-muted small mb-0">当前系统在册</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">教授人数</p>
          <p class="display-6 fw-semibold mb-0">{{ teacher_title_map.get('Professor', 0) }}</p>
          <p class="text-muted small mb-0">Title = Professor</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">讲师人数</p>
          <p class="display-6 fw-semibold mb-0">{{ teacher_title_map.get('Lecturer', 0) }}</p>
          <p class="text-muted small mb-0">Title = Lecturer</p>
        </div>
      </div>
    </div>
  </section>

  <div class="row g-4 mb-4 align-items-stretch">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h2 class="h5 mb-0"><i class="bi bi-person-plus-fill me-2 text-warning"></i>新增教师</h2>
        </div>
        <div class="card-body">
          <form class="row g-3 justify-content-center text-center" method="post" action="{{ url_for('main.manage_teachers') }}">
            <div class="col-sm-6">
              <label class="form-label" for="tno">工号 *</label>
              <input class="form-control" id="tno" name="tno" maxlength="10" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="tname">姓名 *</label>
              <input class="form-control" id="tname" name="tname" maxlength="50" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="title">职称 *</label>
              <select class="form-select" id="title" name="title" required>
                <option value="">请选择职称</option>
                {% for title in teacher_titles %}
                  <option value="{{ title }}">{{ title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="teacher-dno">所属院系</label>
              <select class="form-select" id="teacher-dno" name="dno">
                <option value="">未指定</option>
                {% for dept in departments %}
                  <option value="{{ dept.dno }}">{{ dept.dname }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="teacher-email">邮箱</label>
              <input class="form-control" id="teacher-email" name="email" type="email" maxlength="100">
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="teacher-phone">电话</label>
              <input class="form-control" id="teacher-phone" name="phone" maxlength="20">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">创建教师</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h3 class="h6 mb-0"><i class="bi bi-bar-chart-fill me-2 text-warning"></i>职称分布</h3>
        </div>
        <div class="card-body">
          <canvas id="teacherTitleChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 text-center">
      <h2 class="h5 mb-1"><i class="bi bi-person-lines-fill me-2 text-warning"></i>教师列表</h2>
      <p class="text-muted small mb-0">掌握师资结构与联系方式，支持快速检索。</p>
    </div>
    <div class="card-body">
      <div class="row g-3 mb-3 justify-content-center">
        <div class="col-12 col-lg-6">
          <label class="form-label" for="teacher-search">快速模糊搜索</label>
          <input class="form-control" id="teacher-search" placeholder="输入姓名、院系或职称过滤表格">
        </div>
      </div>
      {% if teachers %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle" id="teachers-table">
            <thead>
              <tr>
                <th scope="col">工号</th>
                <th scope="col">姓名</th>
                <th scope="col">职称</th>
                <th scope="col">院系</th>
                <th scope="col">邮箱</th>
                <th scope="col">电话</th>
                <th scope="col" class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for teacher in teachers %}
                <tr>
                  <td class="fw-semibold">{{ teacher.tno }}</td>
                  <td>
                    <input class="form-control form-control-sm" form="update-teacher-{{ teacher.tno }}" name="tname" value="{{ teacher.tname }}" maxlength="50">
                  </td>
                  <td>
                    <select class="form-select form-select-sm" form="update-teacher-{{ teacher.tno }}" name="title">
                      {% for title in teacher_titles %}
                        <option value="{{ title }}" {% if teacher.title == title %}selected{% endif %}>{{ title }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <select class="form-select form-select-sm" form="update-teacher-{{ teacher.tno }}" name="dno">
                      <option value="">未指定</option>
                      {% for dept in departments %}
                        <option value="{{ dept.dno }}" {% if teacher.dno == dept.dno %}selected{% endif %}>{{ dept.dname }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-teacher-{{ teacher.tno }}" name="email" type="email" value="{{ teacher.email or '' }}" maxlength="100">
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-teacher-{{ teacher.tno }}" name="phone" value="{{ teacher.phone or '' }}" maxlength="20">
                  </td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">
                      <form id="update-teacher-{{ teacher.tno }}" method="post" action="{{ url_for('main.update_teacher', tno=teacher.tno) }}"></form>
                      <button class="btn btn-sm btn-outline-primary" form="update-teacher-{{ teacher.tno }}" type="submit">保存</button>
                      <form method="post" action="{{ url_for('main.delete_teacher', tno=teacher.tno) }}">
                        <input type="hidden" name="delete_action" value="restrict">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="button"
                          data-delete-intro="根据参照完整性，删除教师将同步清理其授课安排（不可置空），是否继续？"
                          data-has-references="{{ 'true' if teacher.teachings|length else 'false' }}"
                          onclick="return handleDeleteAction(this, '教师', false)"
                        >
                          删除
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">暂无教师信息。</p>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);}else{fn();} }
      function ensureChart(cb){
        if (window.Chart) return cb();
        var s=document.createElement('script');
        s.src="{{ url_for('static', filename='js/chart.umd.min.js') }}";
        s.onload=cb; s.onerror=function(){ console.error('Chart.js 加载失败'); };
        document.body.appendChild(s);
      }
      function ensureCanvasMinHeight(canvas, px){
        try{
          const h = parseFloat(getComputedStyle(canvas).height);
          if (!h || h < 10) canvas.style.minHeight = (px||260)+'px';
        }catch(e){}
      }
      function setupTableFilter(inputId, tableId){
        const input=document.getElementById(inputId);
        const table=document.getElementById(tableId);
        if(!input||!table) return;
        const rows=Array.from(table.querySelectorAll('tbody tr'));
        input.addEventListener('input',()=>{
          const kws=input.value.trim().toLowerCase().split(/\s+/).filter(Boolean);
          rows.forEach(r=>{
            if(!kws.length){ r.style.display=''; return; }
            const txt=r.innerText.toLowerCase();
            r.style.display = kws.every(k=>txt.includes(k)) ? '' : 'none';
          });
        });
      }

      ready(function(){
        ensureChart(function(){
          const ctx = document.getElementById('teacherTitleChart');
          if (ctx && window.Chart){
            ensureCanvasMinHeight(ctx, 260);

            const labels = {{ teacher_title_labels | tojson }};
            const values = {{ teacher_title_values | tojson }};

            if (labels && values && labels.length && values.length){
              const colors = labels.map((_,i)=>`hsla(${(i*70)%360},65%,60%,0.85)`);
              new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label:'人数', data: values, backgroundColor: colors, borderRadius: 12 }] },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  aspectRatio: 1.6,
                  plugins: { legend: { display:false } },
                  scales: { y: { beginAtZero:true, ticks:{ precision:0 } } }
                }
              });
            } else {
              ctx.insertAdjacentHTML('afterend','<p class="text-muted small mb-0">暂无职称分布数据。</p>');
            }
          }
          setupTableFilter('teacher-search','teachers-table');
        });
      });
    })();
  </script>
{% endblock %}

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}教务系统（数据库辅助学习版）{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" integrity="sha384-SYITaDbCT4vzgt2ArtyTc95H8333Adxpv8uKXuX4nHCqB6f+GO6zkRgZNpmMQdC6" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block head %}{% endblock %}
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    {% set current_endpoint = request.endpoint or '' %}
    {% set integrity_prefix = '操作不符合完整性约束' %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="{{ url_for('main.index') }}">
          <img alt="系统 Logo" src="{{ url_for('static', filename='img/logo.svg') }}" width="28" height="28" class="d-inline-block align-text-top">
          教务系统（数据库辅助学习版）
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link {% if current_endpoint == 'main.index' %}active{% endif %}" href="{{ url_for('main.index') }}">
                <i class="bi bi-speedometer2 me-1"></i> 仪表盘
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_students' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_students') }}">
                <i class="bi bi-mortarboard me-1"></i> 学生
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_courses' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_courses') }}">
                <i class="bi bi-journal-bookmark me-1"></i> 课程
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_enrollments' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_enrollments') }}">
                <i class="bi bi-card-checklist me-1"></i> 选课
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_teachers' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_teachers') }}">
                <i class="bi bi-person-badge me-1"></i> 教师
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_classrooms' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_classrooms') }}">
                <i class="bi bi-building me-1"></i> 教室
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if 'manage_teachings' in current_endpoint %}active{% endif %}" href="{{ url_for('main.manage_teachings') }}">
                <i class="bi bi-calendar2-week me-1"></i> 授课
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <main class="flex-grow-1 py-4">
      <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-3">
              {% for category, message in messages %}
                {% set bs_category = category if category in ['primary','secondary','success','danger','warning','info','light','dark'] else 'info' %}
                {% set is_integrity_violation = message.startswith(integrity_prefix) %}
                <div
                  class="alert alert-{{ bs_category }} alert-dismissible fade show"
                  role="alert"
                  {% if is_integrity_violation %}
                    data-integrity-alert="true"
                    data-integrity-message="{{ message|e }}"
                  {% endif %}
                >
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </div>
    </main>
    <footer class="py-3 bg-white border-top">
      <div class="container text-muted small">
        <span>示例环境，仅供演示。</span>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-XTT5lU8xF75J7UFe7xT17+3HQTCBA+klTHUcHC1FxY0An3msTirlqCaCA9uMKbzg" crossorigin="anonymous"></script>
    <script>
      window.handleDeleteAction = function (button, entityLabel, allowNull) {
        const form = button?.form
        if (!form) {
          console.warn('缺少删除表单。')
          return false
        }
        const hasReferences = (button?.dataset?.hasReferences || '').toLowerCase() === 'true'
        if (!hasReferences) {
          const defaultAction = button?.dataset?.defaultAction || 'restrict'
          const input = form.querySelector('input[name="delete_action"]')
          if (input) {
            input.value = defaultAction
          }
          form.submit()
          return false
        }
        const customIntro = button?.dataset?.deleteIntro?.trim()
        const hints = [
          customIntro || `删除 ${entityLabel} 可能影响参照完整性。`,
          '请选择处理方式：',
          '1 - 拒绝执行（若存在关联则终止删除）',
          '2 - 级联删除（连同相关记录一起删除）',
        ]
        if (allowNull) {
          hints.push('3 - 设置相关引用为空值')
        }
        const choice = window.prompt(hints.join('\n'))
        if (!choice) {
          alert('已取消删除操作。')
          return false
        }
        const normalized = choice.trim()
        let action = null
        if (normalized === '1') {
          action = 'restrict'
        } else if (normalized === '2') {
          action = 'cascade'
        } else if (allowNull && normalized === '3') {
          action = 'set_null'
        }
        if (!action) {
          alert(`输入无效，请输入 1 或 2${allowNull ? ' 或 3' : ''}。`)
          return false
        }
        const input = form.querySelector('input[name="delete_action"]')
        if (input) {
          input.value = action
        }
        form.submit()
        return false
      }

      ;(function () {
        const showIntegrityAlerts = () => {
          const alertNodes = document.querySelectorAll('[data-integrity-alert="true"]')
          alertNodes.forEach((node) => {
            const message = node?.dataset?.integrityMessage
            if (message) {
              window.alert(message)
            }
          })
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showIntegrityAlerts, { once: true })
        } else {
          showIntegrityAlerts()
        }
      })()
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>

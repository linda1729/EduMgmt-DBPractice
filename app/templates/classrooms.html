{% extends "base.html" %}

{% block title %}教室管理 · 教务管理平台{% endblock %}

{% block content %}
  <section class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">教室总数</p>
          <p class="display-6 fw-semibold mb-0">{{ classroom_total }}</p>
          <p class="text-muted small mb-0">可用于授课的场地</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">平均容量</p>
          <p class="display-6 fw-semibold mb-0">{{ avg_capacity }}</p>
          <p class="text-muted small mb-0">单位：座位数</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">楼栋数量</p>
          <p class="display-6 fw-semibold mb-0">{{ classroom_building_labels|length }}</p>
          <p class="text-muted small mb-0">独立教学楼</p>
        </div>
      </div>
    </div>
  </section>

  <div class="row g-4 mb-4 align-items-stretch">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h2 class="h5 mb-0"><i class="bi bi-building-add me-2 text-secondary"></i>新增教室</h2>
        </div>
        <div class="card-body">
          <form class="row g-3 justify-content-center text-center" method="post" action="{{ url_for('main.manage_classrooms') }}">
            <div class="col-sm-6">
              <label class="form-label" for="room-id">教室编号 *</label>
              <input class="form-control" id="room-id" name="room_id" maxlength="10" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="building">楼栋 *</label>
              <input class="form-control" id="building" name="building" maxlength="50" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="room-no">房间号 *</label>
              <input class="form-control" id="room-no" name="room_no" maxlength="10" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="capacity">容量 *</label>
              <input class="form-control" id="capacity" name="capacity" type="number" min="10" max="1000" required>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">创建教室</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h3 class="h6 mb-0"><i class="bi bi-building-fill me-2 text-secondary"></i>楼栋分布</h3>
        </div>
        <div class="card-body">
          <canvas id="classroomBuildingChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 text-center">
      <h2 class="h5 mb-1"><i class="bi bi-building-fill-gear me-2 text-secondary"></i>教室列表</h2>
      <p class="text-muted small mb-0">维护教学场地基础信息，支持模糊检索。</p>
    </div>
    <div class="card-body">
      <div class="row g-3 mb-3 justify-content-center">
        <div class="col-sm-6 col-lg-4">
          <label class="form-label" for="classroom-room-id-filter">按教室编号</label>
          <input class="form-control" id="classroom-room-id-filter" placeholder="例如：A1-101">
        </div>
        <div class="col-sm-6 col-lg-4">
          <label class="form-label" for="classroom-room-no-filter">按房间号</label>
          <input class="form-control" id="classroom-room-no-filter" placeholder="例如：101">
        </div>
        <div class="col-sm-6 col-lg-4 align-self-end">
          <p class="text-muted small mb-0">支持按楼栋表单 + 教室编号/房间号组合过滤。</p>
        </div>
      </div>
      {% if classrooms %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle" id="classrooms-table">
            <thead>
              <tr>
                <th scope="col">教室编号</th>
                <th scope="col">楼栋</th>
                <th scope="col">房间号</th>
                <th scope="col">容量</th>
                <th scope="col" class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for classroom in classrooms %}
                <tr data-room-id="{{ classroom.room_id|lower }}" data-room-no="{{ classroom.room_no|lower }}" data-building="{{ classroom.building|lower }}">
                  <td class="fw-semibold">{{ classroom.room_id }}</td>
                  <td>
                    <input class="form-control form-control-sm" form="update-room-{{ classroom.room_id }}" name="building" value="{{ classroom.building }}" maxlength="50">
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-room-{{ classroom.room_id }}" name="room_no" value="{{ classroom.room_no }}" maxlength="10">
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-room-{{ classroom.room_id }}" name="capacity" type="number" min="10" max="1000" value="{{ classroom.capacity }}">
                  </td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">
                      <form id="update-room-{{ classroom.room_id }}" method="post" action="{{ url_for('main.update_classroom', room_id=classroom.room_id) }}"></form>
                      <button class="btn btn-sm btn-outline-primary" form="update-room-{{ classroom.room_id }}" type="submit">保存</button>
                      <form method="post" action="{{ url_for('main.delete_classroom', room_id=classroom.room_id) }}">
                        <input type="hidden" name="delete_action" value="restrict">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="button"
                          data-delete-intro="根据参照完整性，授课安排表中的教室字段会被置空，是否确认执行？"
                          data-has-references="{{ 'true' if classroom.teachings|length else 'false' }}"
                          onclick="return handleDeleteAction(this, '教室', true)"
                        >
                          删除
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">暂无教室数据。</p>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);}else{fn();} }
      function ensureChart(cb){
        if (window.Chart) return cb();
        var s=document.createElement('script');
        s.src="{{ url_for('static', filename='js/chart.umd.min.js') }}";
        s.onload=cb; s.onerror=function(){ console.error('Chart.js 加载失败'); };
        document.body.appendChild(s);
      }
      function ensureMinHeight(canvas, px){
        if (!canvas) return;
        const h = parseFloat(getComputedStyle(canvas).height||'0');
        if (!h || h < 10) canvas.style.minHeight = (px||280)+'px';
      }
      function setupClassroomFilters(tableId){
        const table=document.getElementById(tableId);
        const inputRoomId=document.getElementById('classroom-room-id-filter');
        const inputRoomNo=document.getElementById('classroom-room-no-filter');
        if(!table||!inputRoomId||!inputRoomNo) return;
        const rows=Array.from(table.querySelectorAll('tbody tr'));
        const applyFilter=()=>{
          const roomIdValue=inputRoomId.value.trim().toLowerCase();
          const roomNoValue=inputRoomNo.value.trim().toLowerCase();
          rows.forEach(row=>{
            const rowId=(row.dataset.roomId||'').toLowerCase();
            const rowNo=(row.dataset.roomNo||'').toLowerCase();
            const matchId = !roomIdValue || rowId.includes(roomIdValue);
            const matchNo = !roomNoValue || rowNo.includes(roomNoValue);
            row.style.display = matchId && matchNo ? '' : 'none';
          });
        };
        inputRoomId.addEventListener('input', applyFilter);
        inputRoomNo.addEventListener('input', applyFilter);
      }

      ready(function(){
        ensureChart(function(){
          const ctx = document.getElementById('classroomBuildingChart');
          ensureMinHeight(ctx, 300);

          const labels = {{ classroom_building_labels | tojson }};
          const values = {{ classroom_building_values | tojson }};

          if (ctx && window.Chart && labels.length && values.length){
            const colors = labels.map((_,i)=>`hsla(${(i*75)%360},65%,60%,0.85)`);
            new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label:'教室数量', data: values, backgroundColor: colors, borderRadius: 12 }] },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.6,
                plugins: { legend: { display:false } },
                scales: { y: { beginAtZero:true, ticks:{ precision:0 } } }
              }
            });
          } else if (ctx) {
            ctx.insertAdjacentHTML('afterend','<p class="text-muted small mb-0">暂无楼栋分布数据。</p>');
          }

          setupClassroomFilters('classrooms-table');
        });
      });
    })();
  </script>
{% endblock %}

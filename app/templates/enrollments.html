{% extends "base.html" %}

{% block title %}选课管理 · 教务管理平台{% endblock %}

{% block content %}
  <section class="row g-4 mb-4">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">选课记录</p>
          <p class="display-6 fw-semibold mb-0">{{ enrollment_total }}</p>
          <p class="text-muted small mb-0">SC 表累计</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">已完成</p>
          <p class="display-6 fw-semibold mb-0">{{ enrollment_status_map.get('completed', 0) }}</p>
          <p class="text-muted small mb-0">status = completed</p>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body text-center">
          <p class="text-uppercase text-muted small mb-1">正在选课</p>
          <p class="display-6 fw-semibold mb-0">{{ enrollment_status_map.get('enrolled', 0) }}</p>
          <p class="text-muted small mb-0">status = enrolled</p>
        </div>
      </div>
    </div>
  </section>

  <div class="row g-4 mb-4 align-items-stretch">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h2 class="h5 mb-0"><i class="bi bi-card-checklist me-2 text-info"></i>新增选课记录</h2>
        </div>
        <div class="card-body">
          <form class="row g-3 justify-content-center text-center" method="post" action="{{ url_for('main.manage_enrollments') }}">
            <div class="col-sm-6">
              <label class="form-label" for="enroll-student">学生 *</label>
              <select class="form-select" id="enroll-student" name="sno" required>
                <option value="">请选择学生</option>
                {% for student in students %}
                  <option value="{{ student.sno }}">{{ student.sno }} · {{ student.sname }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="enroll-course">课程 *</label>
              <select class="form-select" id="enroll-course" name="cno" required>
                <option value="">请选择课程</option>
                {% for course in courses %}
                  <option value="{{ course.cno }}">{{ course.cno }} · {{ course.cname }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="enroll-year">学年 *</label>
              <input class="form-control" id="enroll-year" name="year_taken" type="number" min="1990" max="2100" required>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="enroll-term">学期 *</label>
              <select class="form-select" id="enroll-term" name="term" required>
                <option value="">请选择学期</option>
                {% for term in terms %}
                  <option value="{{ term.term_code }}">{{ term.term_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="enroll-status">状态</label>
              <select class="form-select" id="enroll-status" name="status">
                {% for status in statuses %}
                  <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-6">
              <label class="form-label" for="enroll-grade">成绩</label>
              <input class="form-control" id="enroll-grade" name="grade" type="number" step="0.01" min="0" max="100">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">创建选课记录</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0">
          <h3 class="h6 mb-0"><i class="bi bi-pie-chart me-2 text-warning"></i>状态分布</h3>
        </div>
        <div class="card-body">
          <canvas id="enrollmentStatusChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 text-center">
      <h2 class="h5 mb-1"><i class="bi bi-ui-checks-grid me-2 text-info"></i>选课列表</h2>
      <p class="text-muted small mb-0">最多展示 300 条选课记录，可按学生、课程与状态筛选。</p>
    </div>
    <div class="card-body">
      <form class="row g-2 align-items-end mb-4 text-center justify-content-center" method="get" action="{{ url_for('main.manage_enrollments') }}">
        <div class="col-sm-6 col-lg-3">
          <label class="form-label" for="filter-student">学生</label>
          <select class="form-select" id="filter-student" name="student">
            <option value="">全部学生</option>
            {% for student in students %}
              <option value="{{ student.sno }}" {% if student_filter == student.sno %}selected{% endif %}>{{ student.sno }} · {{ student.sname }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-6 col-lg-3">
          <label class="form-label" for="filter-course">课程</label>
          <select class="form-select" id="filter-course" name="course">
            <option value="">全部课程</option>
            {% for course in courses %}
              <option value="{{ course.cno }}" {% if course_filter == course.cno %}selected{% endif %}>{{ course.cno }} · {{ course.cname }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-6 col-lg-3">
          <label class="form-label" for="filter-status">状态</label>
          <select class="form-select" id="filter-status" name="status">
            <option value="">全部状态</option>
            {% for status in statuses %}
              <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-6 col-lg-3 text-sm-end">
          <button class="btn btn-outline-primary me-2" type="submit">筛选</button>
          <a class="btn btn-link text-decoration-none" href="{{ url_for('main.manage_enrollments') }}">清除条件</a>
        </div>
      </form>
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-6">
          <label class="form-label" for="enrollment-search">快速模糊搜索</label>
          <input class="form-control" id="enrollment-search" placeholder="输入关键字过滤表格">
        </div>
      </div>
      {% if enrollments %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle" id="enrollments-table">
            <thead>
              <tr>
                <th scope="col">学生</th>
                <th scope="col">课程</th>
                <th scope="col">学年</th>
                <th scope="col">学期</th>
                <th scope="col">成绩</th>
                <th scope="col">状态</th>
                <th scope="col">选课时间</th>
                <th scope="col" class="text-end">操作</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment, student, course in enrollments %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ student.sname }}</div>
                    <div class="text-muted small">{{ enrollment.sno }}</div>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ course.cname }}</div>
                    <div class="text-muted small">{{ enrollment.cno }}</div>
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" name="year_taken" type="number" min="1990" max="2100" value="{{ enrollment.year_taken }}">
                  </td>
                  <td>
                    <select class="form-select form-select-sm" form="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" name="term">
                      {% for term in terms %}
                        <option value="{{ term.term_code }}" {% if enrollment.term == term.term_code %}selected{% endif %}>{{ term.term_name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input class="form-control form-control-sm" form="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" name="grade" type="number" step="0.01" min="0" max="100" value="{{ '{:.2f}'.format(enrollment.grade) if enrollment.grade is not none else '' }}">
                  </td>
                  <td>
                    <select class="form-select form-select-sm text-capitalize" form="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" name="status">
                      {% for status in statuses %}
                        <option value="{{ status }}" {% if enrollment.status == status %}selected{% endif %}>{{ status }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td class="small text-muted">
                    {{ enrollment.enroll_date.strftime('%Y-%m-%d %H:%M') if enrollment.enroll_date else '—' }}
                  </td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2">
                      <form id="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" method="post" action="{{ url_for('main.update_enrollment', sno=enrollment.sno, cno=enrollment.cno) }}"></form>
                      <button class="btn btn-sm btn-outline-primary" form="update-enroll-{{ enrollment.sno }}-{{ enrollment.cno }}" type="submit">保存</button>
                      <form method="post" action="{{ url_for('main.delete_enrollment', sno=enrollment.sno, cno=enrollment.cno) }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('确认删除选课 {{ enrollment.sno }} - {{ enrollment.cno }} 吗？')">删除</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">暂无选课记录。</p>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);}else{fn();} }
      function ensureChart(cb){
        if (window.Chart) return cb();
        var s=document.createElement('script');
        s.src="{{ url_for('static', filename='js/chart.umd.min.js') }}";
        s.onload=cb; s.onerror=function(){ console.error('Chart.js 加载失败'); };
        document.body.appendChild(s);
      }
      function ensureMinHeight(canvas, px){
        if (!canvas) return;
        const h = parseFloat(getComputedStyle(canvas).height||'0');
        if (!h || h < 10) canvas.style.minHeight = (px||260)+'px';
      }
      function setupTableFilter(inputId, tableId){
        const input=document.getElementById(inputId);
        const table=document.getElementById(tableId);
        if(!input||!table) return;
        const rows=Array.from(table.querySelectorAll('tbody tr'));
        input.addEventListener('input',()=>{
          const kws=input.value.trim().toLowerCase().split(/\s+/).filter(Boolean);
          rows.forEach(r=>{
            if(!kws.length){ r.style.display=''; return; }
            const txt=r.innerText.toLowerCase();
            r.style.display = kws.every(k=>txt.includes(k)) ? '' : 'none';
          });
        });
      }

      ready(function(){
        ensureChart(function(){
          const ctx = document.getElementById('enrollmentStatusChart');
          ensureMinHeight(ctx, 260);

          const labels = {{ enrollment_status_labels | tojson }};
          const values = {{ enrollment_status_values | tojson }};
          if (ctx && window.Chart && labels.length && values.length){
            const colors = labels.map((_,i)=>`hsla(${(i*80)%360},70%,65%,0.85)`);
            new Chart(ctx, {
              type: 'doughnut',
              data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.6,
                plugins: { legend: { position: 'bottom' } }
              }
            });
          } else if (ctx) {
            ctx.insertAdjacentHTML('afterend','<p class="text-muted small mb-0">暂无选课状态数据。</p>');
          }

          setupTableFilter('enrollment-search','enrollments-table');
        });
      });
    })();
  </script>
{% endblock %}
